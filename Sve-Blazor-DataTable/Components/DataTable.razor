@using System.Text;
@using System.Collections.ObjectModel;
@using System.Linq.Dynamic.Core;
@using System.Linq;
@using System.Linq.Expressions;

@inject IJSRuntime JSRuntime

@typeparam TModel

@if (Columns.Any(e => e.IsFilterable))
{
   <DataTableActions IncludeSearchButton="IncludeSearchButton"
                     IncludeToggleFilters="IncludeToggleFilters"
                     ShowHeaderFilters="ShowHeaderFilters"
                     ApplyFilters="ApplyFilters"
                     ShowHeaderFiltersChangedEvent="(showHeaderFilters) => ShowHeaderFilters = showHeaderFilters"/>
}

<CascadingValue Value="this">
    <div class="@ContainerCssClass" style='@(UsePaging ? "" : $"overflow: auto; height: {ContainerHeight}px; position: relative") '>

        <table id="@Id" class="@CssClass @GetTableStyleCssClasses()" @attributes="Attributes">
            <thead>
                <tr>
                    @foreach (DataTableColumn<TModel> column in Columns)
                    {
                    <th class="@column.CssClass" style='text-align: @column.TextAlignment; @GetTableHeaderBorderStyle() top: 0; position: sticky; z-index: 1; border-top: none; background-color: @(Styles.HasFlag(TableStyle.Dark) ? "black" : "white");' id="@column.Guid.ToString();" nowrap>

                        @if (column.CustomTitle != null)
                        {
                            <span style="cursor: pointer" @onclick="(args) => OnColumnHeaderClickedEvent(args, column)">@column.CustomTitle</span>
                        }
                        else
                        {
                            <span style="cursor: pointer" @onclick="(args) => OnColumnHeaderClickedEvent(args, column)">@column.GetColumnVisualPropertyName()</span>
                        }

                        <div class="d-inline-block">
                            @if (column.IsSortable)
                            {
                                @if (SortColumnGuid.HasValue && column.Guid == SortColumnGuid.Value)
                                {
                                    @if (SortDirection == SortDirection.Descending)
                                    {
                                        <img style="cursor: pointer" height="15" width="15" alt="SortDown" @onclick="(args) => OnColumnHeaderClickedEvent(args, column)" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABhElEQVR4Xu2YMUqDQRCFvxQ2duItbFJZBsE7eA5BMNhYi0XwIJ7BTq3tvIVtGkFZSCCVuLMzO8W8v0rxz768b9/LsllQ/FkU948AKAHFCagCxQOgH0FVQBUoTkAVKB4AnQKqgCpQnIAqUDwAOgVUAVWgOAFVoHgAdAqoAqpAcQKqQPEA6BRQBVSB4gRUgYEAHANXwMnAGh6jX8AzsLUsZk3AEfAGnFtEA2begQvgu3dtK4BL4KVXLPj9FfDaq2EFsAQ+esWC3z8DPns1rACazga46RUMev8RuLOsPQKgzT4B1xZhx5m2EbfAj2XNEQBNLxvCkPm9AQu4w5ksCMPmvQBkJMHFvCeAmRDczHsDmAHB1XwEgEgI7uajAERACDEfCcATQpj5aAAeEELNzwAwAiHc/CwAFghTzM8E0ANhmvnZAP4DYar5DAB/QZhuPgvAXvcBWO+use3zvfVKO3KbG70Oj2i32dOd6fbHZsqTDSDF9KGoAKRvQfIXUAKSNyBdvnwCfgHh8z9BuCGmqwAAAABJRU5ErkJggg==" />
                                    }
                                    else
                                    {
                                        <img style="cursor: pointer" height="15" width="15" alt="SortUp" @onclick="(args) => OnColumnHeaderClickedEvent(args, column)" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABlUlEQVR4Xu3XMUoEURCE4d9AMDfxECZmBgZ6BM8hCIqBZxANxIN4AwPR1MxDCF7AQJSBNREWfW+66zVMbTw71f11bbAbLPyzsfD9MYAbsHAB/wQGF2AH+ALeRs0xqgFT7jVwvlr8CrhcYUgtRgBMmXfAya9Nb4EzNYIaYN3yPxZyBCXAX8sPQVAB/Hd5OYICoHV5KUI2QO/yMoRMgLnLSxCyAKKWT0fIAIhePhUhGiBr+TSESIDs5VMQogBUy4cjRAColw9FmAswavkwhDkAo5cPQZgDMP1zO5X+eV8fdgNc9MzSC7AHvPQEJn5nF3htfX8vwBHw0BqW/PwB8Nya0QuwCTwC+62BSc8/AYfAZ+v7ewGmnC3gGNhuDQ1+/h24Bz563jsHoCev3HcMUO4k4oHcADF4uTg3oNxJxAO5AWLwcnFuQLmTiAdyA8Tg5eLcgHInEQ/kBojBy8W5AeVOIh7IDRCDl4tzA8qdRDyQGyAGLxfnBpQ7iXggN0AMXi7ODSh3EvFAboAYvFycG1DuJOKBFt+AbyhyPkHtGJ1/AAAAAElFTkSuQmCC" />
                                    }
                                }
                                else
                                {
                                    <img style="cursor: pointer" height="15" width="15" alt="SortUpDown" @onclick="(args) => OnColumnHeaderClickedEvent(args, column)" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB20lEQVR4nO2bsU5CQRBFD2KMiVZ2hkTp/AITJVYmNnyDX+dHmGhhZWj4AkNC6OysLGyMFrCdBNi5M6sypwKS+3bvoeHtGyBJkiRJtpZOw7WvgavF62fgqcUmui0WBYbAJfMvoAOcAgfAJHojLQQMgfMfPu/RQEK0gGXlC+ESIgWsKl8IlRAlYN3yhTAJEQI2LV8IkeAtoLZ8wV2CpwBr+YKrBC8BqvIFNwkeAtTlCy4S1AK8yhfkEpQCvMsXpBJUAqLKF2QSFAKiyxckEqwCWpUvmCVYBNwAF4a8ih6wB0xrwjuGhQeGrJoBcFQTtAj4bezXhCwCZoasmhnwWhO0nAl2gTPg0HANBe/AC/DZeB9JkiRJkvwxtv6H0K5h4Vugb8grmQF3wNemQcu9QN+QVdMHjmuC/+lu8KMmZBEwMmTVjIC3mqDlRGjK/DiqZ7iGgjHwUBu2nglOaCthDNxbLqA4FW4lwVwedM8FoiVIyoP2yVCUBFl50D8b9JYgLQ8+T4e9JMjLg998gFqCS3nwnRBRSXArD/4zQlYJruUhZkqsVoJ7eYibE9xUQkh5iJ0UXVdCWHmInxVeJSG0PLSZFl8mIbw8tPu/wGSx9sni/TPw2GgvSZIkSbKtfANxTVKVOblB2wAAAABJRU5ErkJggg==" />
                                }
                            }

                            @if (column.IsFilterable)
                            {
                                <img style="cursor: pointer" height="15" width="15" alt="SortUpDown" data-toggle="modal" data-target="#advancedFilterModal" @onclick="(args) => OnColumnFilterClickedEvent(args, column)" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAgAElEQVR4Xu3dXci1bVoX8MNUclDyE4zAFBxpCr+jqLDR3MiN3FBKMpTQCFT8oA0zImqmGoJ0q7QokdwI/IDRHZ1AN3IjrSAbdwyqcZAIBUVERAVJB1nM/ea8r8/zPmut+1rHdf7P4/dsDcxa13mcv/95z/mfdd/P/XxY+UOAAAECBAiME/iwcTu2YQIECBAgQKAUAIeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAABAgQUAGeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAABAgQUAGeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAABAgQUAGeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAABAgQUAGeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAABAgQUAGeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAABAgQUAGeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAABAgQUAGeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAABAgQUAGeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAABAgQUAGeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAABAgQUAGeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAABAgQUAGeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAABAgQUAGeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAABAgQUAGeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAABAgQUAGeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAABAgQUAGeAAAECBAgMFFAABoZuywQIECBAQAFwBggQIECAwEABBWBg6LZMgAAB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" />

                                int count = FilterRules.Count(e => e.IsApplied && e.Column.Guid == column.Guid);

                                @if (count > 0)
                                {
                                    <span class="badge badge-light" style="padding: 0; vertical-align: bottom;">@count</span>
                                }
                            }
                        </div>

                        @if (column.IncludeHeaderFilter && ShowHeaderFilters && HeaderFilterRules.SingleOrDefault(e => e.Column.Guid == column.Guid) != null)
                        {
                            <div>
                                <DataTableFilterInput TModel="TModel"
                                                      IsHeaderRule="true"
                                                      FilterRule="HeaderFilterRules.Single(e => e.Column.Guid == column.Guid)"
                                                      ApplyFilter="ApplyFilter" 
                                                      UnApplyFilter="UnApplyFilter"/>
                            </div>
                        }
                    </th>
                    }
                </tr>
            </thead>

            @if (UsePaging)
            {
                <tbody>
                    @foreach (var item in Items)
                    {
                        <tr>
                            @foreach (DataTableColumn<TModel> column in Columns)
                            {
                                if (column.Template != null)
                                {
                                    <td style="text-align: @column.TextAlignment;">@column.Template(item)</td>
                                }
                                else if (column.ChildContent != null)
                                {
                                    <td style="text-align: @column.TextAlignment;">@column.ChildContent</td>
                                }
                                else if (column.Property != null)
                                {
                                    var expression = column.Property.Compile();
                                    var result = expression.DynamicInvoke(item);
                                    <td style="text-align: @column.TextAlignment;">@result</td>
                                }
                                else
                                {
                                    <td style="text-align: @column.TextAlignment;"></td>
                                }
                            }
                        </tr>
                    }
                </tbody>
            }
            else
            {
                <Virtualize TModel="TModel" TagName="tbody" ItemHeight="@GetItemHeight()" Items="Items" Context="item">
                    <tr id="@item.GetHashCode()" style="height: 25px;">

                        @foreach (DataTableColumn<TModel> column in Columns)
                        {
                            if (column.Template != null)
                            {
                                <td style="height: 25px; @GetTableDataRowBorderStyle() text-align: @column.TextAlignment;">@column.Template(item)</td>
                            }
                            else if (column.ChildContent != null)
                            {
                                <td style="height: 25px; @GetTableDataRowBorderStyle() text-align: @column.TextAlignment;">@column.ChildContent</td>
                            }
                            else if (column.Property != null)
                            {
                                var expression = column.Property.Compile();
                                var result = expression.DynamicInvoke(item);
                                <td style="height: 25px; @GetTableDataRowBorderStyle() text-align: @column.TextAlignment;">@result</td>
                            }
                            else
                            {
                                <td style="height: 25px; @GetTableDataRowBorderStyle() text-align: @column.TextAlignment;"></td>
                            }
                        }
                    </tr>
                </Virtualize>

            }
        </table>

        @if (UsePaging)
        {
            <Paging PageCount="PageCount"
                    ActivePageNr="PageNr"
                    GoToPageEvent="OnGoToPageEvent" />
        }

    </div>

    @ChildContent
</CascadingValue>

<DataTableFilterRulesModal TModel="TModel"
                           FilterRules="FilterRules"
                           RemoveUnusedFilters="RemoveUnusedFilters"
                           RemoveFilterRule="RemoveFilterRule"
                           ApplyFilter="ApplyFilter"
                           ApplyFilters="ApplyFilters"
                           AddFilterRule="AddFilterRule"
                           FilterableColumnProperties="FilterableColumnProperties"
                           SelectedPropertyForFilterRuleChanged="OnSelectedPropertyForFilterRuleChanged"/>

@code {
    [Parameter]
    public IList<TModel> Items { get; set; } = new List<TModel>();

    [Parameter]
    public string Id { get; set; } = "";

    [Parameter]
    public string ContainerCssClass { get; set; } = "table-responsive";

    [Parameter]
    public string CssClass { get; set; } = "table";

    [Parameter]
    public TableStyle Styles { get; set; }

    [Parameter]
    public ReadOnlyDictionary<string, object>? Attributes { get; set; }

    [Parameter]
    public bool UsePaging { get; set; }

    [Parameter]
    public int PageNr { get; set; } = 1;

    [Parameter]
    public int PageSize { get; set; } = 10;

    [Parameter]
    public int PageCount { get; set; } = 1;

    [Parameter]
    public Func<RequestArgs<TModel>, Task>? FetchData { get; set; }

    [Parameter]
    public bool ShowHeaderFilters { get; set; } = true;

    [Parameter]
    public int ContainerHeight { get; set; } = 300;

    [Parameter]
    public bool IncludeSearchButton { get; set; } = false;

    [Parameter]
    public bool IncludeToggleFilters { get; set; } = false;

    /// <summary>
    /// When true applying a value in a header filter will trigger a search
    /// </summary>
    [Parameter]
    public bool SearchOnApplyHeaderFilter { get; set; } = false;

    /// <summary>
    /// Determines whether or not to automatically add a (non applied) filter to the modal, after pressing the filter button on a column (only when there are no applied filters).
    /// </summary>
    [Parameter]
    public bool AutoAddFilterWhenClickedAndNoneActive { get; set; } = true;

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private IList<TModel> AllItems { get; set; } = new List<TModel>();

    private Guid? SortColumnGuid { get; set; }
    private SortDirection SortDirection { get; set; } = SortDirection.Ascending;
    private string SortColumn { get; set; }

    private Dictionary<Guid, string> FilterableColumnProperties = new Dictionary<Guid, string>();
    private IList<FilterRule<TModel>> FilterRules { get; set; } = new List<FilterRule<TModel>>();
    private IList<FilterRule<TModel>> HeaderFilterRules { get; set; } = new List<FilterRule<TModel>>();
    private IList<DataTableColumn<TModel>> Columns { get; set; } = new List<DataTableColumn<TModel>>();

    public void AddColumn(DataTableColumn<TModel> column)
    {
        Columns.Add(column);

        if (column.IsDefaultSortColumn)
        {
            SortColumnGuid = column.Guid;
            SortDirection = column.DefaultSortDirection;
            SortColumn = column.GetColumnVisualPropertyName();
        }

        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        if (Items == null) Items = new List<TModel>();

        AllItems = Items;

        if (FetchData != null && (AllItems.Count == 0)) await FetchData.Invoke(new RequestArgs<TModel>(PageNr, PageSize, SortDirection, SortColumn, FilterRules));
        else if (UsePaging && FetchData == null) await PerformClientSideDataManipulations();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            foreach (DataTableColumn<TModel> column in Columns.Where(e => e.IsFilterable))
            {
                if (column.CustomTitle != null) FilterableColumnProperties.Add(column.Guid, column.CustomTitle);
                else FilterableColumnProperties.Add(column.Guid, column.GetColumnVisualPropertyName());
                if (column.IncludeHeaderFilter) HeaderFilterRules.Add(new FilterRule<TModel>(column, column.PropertyType, column.GetColumnVisualPropertyName(), ObjectFilter.Equals)); //TODO: Support multiple grid filter types in the future?
            }
            StateHasChanged();
        }
    }

    private string GetTableStyleCssClasses()
    {
        StringBuilder classes = new StringBuilder();

        Styles.ToString().Split(',').Where(e => !string.IsNullOrEmpty(e.ToLower())).ToList().ForEach(e => classes.Append($"table-{e.Trim().ToLower()} "));

        return classes.ToString();
    }

    private string GetTableHeaderBorderStyle()
    {
        //if (Styles.HasFlag(TableStyle.Bordered)) return "box-shadow: inset 1px 1px #dee2e6, 1px 1px #dee2e6;";
        if (Styles.HasFlag(TableStyle.Bordered)) return "box-shadow: inset 1px 1px #dee2e6, 1px 1px #dee2e6; border: none;";
        else if (Styles.HasFlag(TableStyle.Borderless)) return "";
        else return "box-shadow: inset 0px 1px #dee2e6, 0 1px #dee2e6;";
    }

    private string GetTableDataRowBorderStyle()
    {
        if (Styles.HasFlag(TableStyle.Bordered)) return "box-shadow: inset 1px -1px #dee2e6; border: none;";
        else if (Styles.HasFlag(TableStyle.Borderless)) return "";
        else return "box-shadow: inset 0px -1px #dee2e6;";
    }

    private int GetItemHeight()
    {
        if (Styles.HasFlag(TableStyle.Sm)) return 25;
        else return 90;
    }

    private async Task OnColumnHeaderClickedEvent(MouseEventArgs clickEvent, DataTableColumn<TModel> column)
    {
        if (!column.IsSortable) return;

        // 1. It is the column currently sorted on, so all we do is change the SortDirection
        if (column.Guid == SortColumnGuid)
        {
            if (SortDirection == SortDirection.Ascending) SortDirection = SortDirection.Descending;
            else SortDirection = SortDirection.Ascending;
        }

        // 2. It is a different column, so all we do is change the SortColumn
        else
        {
            SortColumnGuid = column.Guid;
            SortColumn = column.GetColumnPropertyName();
        }

        // Server or client side
        if (FetchData == null)
        {
            if (UsePaging) await PerformClientSideDataManipulations();
            else Items = Items.AsQueryable().OrderBy($"{SortColumn} {SortDirection.ToString().ToLower()}").ToList();
            StateHasChanged();
        }
        else await FetchData.Invoke(new RequestArgs<TModel>(PageNr, PageSize, SortDirection, SortColumn, FilterRules));

    }

    private async Task OnGoToPageEvent(int pageNr)
    {
        PageNr = pageNr;
        if (FetchData == null) await PerformClientSideDataManipulations();
        else await FetchData.Invoke(new RequestArgs<TModel>(PageNr, PageSize, SortDirection, SortColumn, FilterRules));
    }

    private void OnColumnFilterClickedEvent(MouseEventArgs clickEvent, DataTableColumn<TModel> column)
    {
        if (FilterRules.Count == 0 && AutoAddFilterWhenClickedAndNoneActive) AddFilterRule(column);
    }

    private void AddFilterRule(DataTableColumn<TModel>? column = null)
    {
        if (column == null) column = Columns.First(e => e.IsFilterable);
        FilterRules.Add(new FilterRule<TModel>(column, column.PropertyType, column.GetColumnVisualPropertyName(), ObjectFilter.Equals));
        StateHasChanged();
    }

    private void RemoveFilterRule(Guid guid)
    {
        FilterRule<TModel>? filterRuleToDelete = FilterRules.SingleOrDefault(e => e.Guid == guid);
        if (filterRuleToDelete != null)
        {
            FilterRules.Remove(filterRuleToDelete);
            PageNr = 1;
        }
    }

    /// <summary>
    /// Used to clear filters that aren't applied
    /// </summary>
    private void RemoveUnusedFilters()
    {
        FilterRules = FilterRules.Where(e => e.IsApplied).ToList();
    }

    private void OnSelectedPropertyForFilterRuleChanged(ChangeEventArgs args, FilterRule<TModel> filterRule)
    {
        Guid columnGuid = Guid.Parse(args.Value.ToString());
        var newlySelectedColumn = Columns.Single(e => e.Guid == columnGuid);
        filterRule.UpdateFilterProperty(newlySelectedColumn, newlySelectedColumn.PropertyType, newlySelectedColumn.GetColumnVisualPropertyName());
    }

    private async Task ApplyFilters()
    {
        RemoveUnusedFilters();

        if (FetchData == null) await PerformClientSideDataManipulations();
        else await FetchData.Invoke(new RequestArgs<TModel>(PageNr, PageSize, SortDirection, SortColumn, FilterRules.Concat(HeaderFilterRules.Where(e => e.IsApplied)).ToList()));
    }

    private async Task ApplyFilter(Guid filterRuleGiud, bool isHeaderRule = false)
    {
        if (isHeaderRule)
        {
            HeaderFilterRules.Single(e => e.Guid == filterRuleGiud).IsApplied = true;
            if (SearchOnApplyHeaderFilter) await ApplyFilters();
        }
        else FilterRules.Single(e => e.Guid == filterRuleGiud).IsApplied = true;

        PageNr = 1;
    }

    private  async Task UnApplyFilter(Guid filterRuleGiud, bool isHeaderRule = false)
    {
        if (isHeaderRule)
        {
            HeaderFilterRules.Single(e => e.Guid == filterRuleGiud).IsApplied = false;
            if (SearchOnApplyHeaderFilter) await ApplyFilters();
        }
        else FilterRules.Single(e => e.Guid == filterRuleGiud).IsApplied = false;

        PageNr = 1;
    }

    private Task PerformClientSideDataManipulations()
    {
        bool useFilteredResult = false;
        List<FilterRule<TModel>> AllFilterRules = FilterRules.Concat(HeaderFilterRules.Where(e => e.IsApplied)).ToList();

        if (AllFilterRules.Count == 0) Items = AllItems;
        else
        {
            Expression<Func<TModel, bool>>? filterExpression = null;

            foreach (var filterRule in AllFilterRules)
            {
                var filterRuleExpression = filterRule.GenerateExpression();

                if (filterExpression == null) filterExpression = filterRuleExpression;
                else filterExpression = PredicateBuilder.And(filterExpression, filterRuleExpression);
            }

            Items = AllItems.AsQueryable().Where(filterExpression).ToList();

            useFilteredResult = true;
        }

        if (UsePaging)
        {
            Sve.Blazor.Core.Models.PagedResult<TModel>? pagedResult = null;

            if (useFilteredResult) pagedResult = Utils.ApplyPaging(Items.AsQueryable(), new Pager(PageNr, PageSize, SortColumn, SortDirection));
            else pagedResult = Utils.ApplyPaging(AllItems.AsQueryable(), new Pager(PageNr, PageSize, SortColumn, SortDirection));

            Items = pagedResult.Data;
            PageCount = pagedResult.Paging.PageCount;
        }

        StateHasChanged();

        return Task.CompletedTask;
    }
}
